# For educational purposes only
version: 1
template_name: kgiop_monitor
meta:
  id: deep-dive.kgiop_gike_monitor
  name: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ì–ò–ö–≠ –ö–ì–ò–û–ü
  description: –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –ø–æ—è–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –∏—Å—Ç–æ—Ä–∏–∫–æ-–∫—É–ª—å—Ç—É—Ä–Ω—ã—Ö —ç–∫—Å–ø–µ—Ä—Ç–∏–∑ –Ω–∞ —Å–∞–π—Ç–µ –ö–ì–ò–û–ü –°–ü–±
  tags: ["–∫—É–ª—å—Ç—É—Ä–Ω–æ–µ –Ω–∞—Å–ª–µ–¥–∏–µ", "–°–ü–±", "—ç–∫—Å–ø–µ—Ä—Ç–∏–∑—ã", "PDF"]
  category: "deep-dive"

source:
  type: html
  url: |
    {% set current_year = now().year %}
    https://kgiop.gov.spb.ru/deyatelnost/zaklyucheniya-gosudarstvennyh-istoriko-kulturnyh-ekspertiz/gosudarstvennye-istoriko-kulturnye-ekspertizy-za-{{ current_year }}-g/
  frequency: daily
  fetch:
    retry_policy:
      max_retries: 3
      backoff_factor: 2
    verify_ssl: false  

extract:
  events:
    selector: "a[href*='/media/uploads/userfiles/'], a[href*='disk.yandex.ru']"
    type: list
    limit: 20
    fields:
      title: "self"
      url:
        attr: "href"
        transform_type: "smart_url"
download:
  extensextensions: [".pdf", "yandex.ru"]  # –†–∞–∑—Ä–µ—à–∏—Ç—å –¥–æ–º–µ–Ω –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫–∞ions: [".pdf"]
  timeout: 20    

processing:
  extract_regex:
    - "^.{1,200}"  # –ù–∞—á–∞–ª–æ —Ç–µ–∫—Å—Ç–∞
    - "–∞–¥—Ä–µ—Å[:\\s]\\s*(.{10,100}?)(?=\\n|$)"  # –ê–¥—Ä–µ—Å –æ–±—ä–µ–∫—Ç–∞
    - "–ø—Ä–æ–µ–∫—Ç(.{0,200}?–ø—Ä–µ–¥—É—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç(?:—Å—è)?)"  # –ü—Ä–æ–µ–∫—Ç + –ø—Ä–µ–¥—É—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç
    - "–∑–∞–∫–∞–∑—á–∏–∫(?:–∞|—É|–æ–º)?\\s*:?\\s*(.{10,100}?)(?=\\n|$)"  # –ó–∞–∫–∞–∑—á–∏–∫
    - "(?:–≤—ã–≤–æ–¥—ã?|–∑–∞–∫–ª—é—á–µ–Ω–∏–µ)\\s*(.{50,300}?)(?=\\n|$)"  # –í—ã–≤–æ–¥—ã/–∑–∞–∫–ª—é—á–µ–Ω–∏–µ


normalize:
  rules:
    - field: events
      filters:
        - unique: "event_id"
        - filter: "documents"

#gpt:
#  prompt: |
#    
#    –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ç–µ–∫—Å—Ç —ç–∫—Å–ø–µ—Ä—Ç–∏–∑—ã –Ω–∏–∂–µ –∏ –≤—ã–¥–µ–ª–∏:
#
#    1. –û–±—ä–µ–∫—Ç –∫—É–ª—å—Ç—É—Ä–Ω–æ–≥–æ –Ω–∞—Å–ª–µ–¥–∏—è
#    2. –ê–¥—Ä–µ—Å
#    3. –ó–∞–∫–∞–∑—á–∏–∫ –∏–ª–∏ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫
#    4. –í–∏–¥—ã —Ä–∞–±–æ—Ç: —Ä–µ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è, —Ä–µ—Å—Ç–∞–≤—Ä–∞—Ü–∏—è –∏ –¥—Ä.
#    5. –ö–∞–¥–∞—Å—Ç—Ä–æ–≤—ã–µ –Ω–æ–º–µ—Ä–∞
#    6. –ö—Ä–∞—Ç–∫–æ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ –∏–ª–∏ –≤—ã–≤–æ–¥
#
#    –í–æ—Ç —Ç–µ–∫—Å—Ç: {{ text }}

alert:
  templates:
    expertise: |
      {% for event in events %}
      === –≠–∫—Å–ø–µ—Ä—Ç–∏–∑–∞ {{ loop.index }} ===
      –ù–∞–∑–≤–∞–Ω–∏–µ: {{ event.title }}
      {% if event.gpt_text %}
      üìù –í—ã–¥–µ—Ä–∂–∫–∞:
      {{ event.gpt_text }}
      {% else %}
      ‚ÑπÔ∏è –í—ã–¥–µ—Ä–∂–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
      {% endif %}
      {% endfor %}
      
test_event:
  url: https://kgiop.gov.spb.ru/media/uploads/userfiles/2023/example_gike.pdf
  note: –¢–µ—Å—Ç–æ–≤–∞—è —ç–∫—Å–ø–µ—Ä—Ç–∏–∑–∞ 2023 –≥–æ–¥–∞
