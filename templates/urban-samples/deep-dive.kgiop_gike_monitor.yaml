# For educational purposes only
version: 1
template_name: kgiop_monitor
meta:
  id: deep-dive.kgiop_gike_monitor
  name: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ì–ò–ö–≠ –ö–ì–ò–û–ü
  description: –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –ø–æ—è–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –∏—Å—Ç–æ—Ä–∏–∫–æ-–∫—É–ª—å—Ç—É—Ä–Ω—ã—Ö —ç–∫—Å–ø–µ—Ä—Ç–∏–∑ –Ω–∞ —Å–∞–π—Ç–µ –ö–ì–ò–û–ü –°–ü–±
  tags: ["–∫—É–ª—å—Ç—É—Ä–Ω–æ–µ –Ω–∞—Å–ª–µ–¥–∏–µ", "–°–ü–±", "—ç–∫—Å–ø–µ—Ä—Ç–∏–∑—ã", "PDF"]
  category: "deep-dive"

source:
  type: html
  url: |
    {% set current_year = now().year %}
    https://kgiop.gov.spb.ru/deyatelnost/zaklyucheniya-gosudarstvennyh-istoriko-kulturnyh-ekspertiz/gosudarstvennye-istoriko-kulturnye-ekspertizy-za-{{ current_year }}-g/
  frequency: daily
  fetch:
    retry_policy:
      max_retries: 3
      backoff_factor: 2
    verify_ssl: false  

extract:
  events:
    selector: "a[href*='/media/uploads/userfiles/'], a[href*='disk.yandex.ru']"
    type: list
    limit: 2
    fields:
      title: "self"
      url:
        attr: "href"
        transform_type: "smart_url"
download:
  extensextensions: [".pdf", "yandex.ru"]  # –†–∞–∑—Ä–µ—à–∏—Ç—å –¥–æ–º–µ–Ω –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫–∞ions: [".pdf"]
  timeout: 20    

processing:
  extract_regex:
    - "^"  # –ù–∞—á–∞–ª–æ —Ç–µ–∫—Å—Ç–∞
    - "–æ–±—ä–µ–∫—Ç. –∫—É–ª—å—Ç—É—Ä–Ω–æ–≥–æ –Ω–∞—Å–ª–µ–¥–∏—è" #–û–±—ä–µ–∫—Ç —ç–∫—Å–ø–µ—Ä—Ç–∏–∑—ã
    - "–∞–¥—Ä–µ—Å[:\\s]\\s*(.{10,100}?)(?=\\n|$)"  # –ê–¥—Ä–µ—Å –æ–±—ä–µ–∫—Ç–∞
    - "–ø—Ä–æ–µ–∫—Ç(?:–∞|—É|–æ–º)"  # –ü—Ä–æ–µ–∫—Ç–æ–º –ø—Ä–µ–¥—É—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç—Å—è
    - "–ø—Ä–µ–¥—É—Å–º" # –ü—Ä–æ–µ–∫—Ç–æ–º –ø—Ä–µ–¥—É—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç—Å—è
    - "–æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤(?:–∞)" # –û–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞ —ç–∫—Å–ø–µ—Ä—Ç–∏–∑—ã
    - "–∑–∞–∫–∞–∑—á–∏–∫(?:–∞|—É|–æ–º)?\\s*:?\\s*(.{10,100}?)(?=\\n|$)"  # –ó–∞–∫–∞–∑—á–∏–∫
    - "(?:–≤—ã–≤–æ–¥—ã?|–∑–∞–∫–ª—é—á–µ–Ω–∏–µ)\\s*(.{50,300}?)(?=\\n|$)"  # –í—ã–≤–æ–¥—ã/–∑–∞–∫–ª—é—á–µ–Ω–∏–µ


normalize:
  rules:
    - field: events
      filters:
        - unique: "event_id"
        - filter: "documents"

gpt:
  prompt: |
    
    –ë–µ–∑ –ª–∏—à–Ω–∏—Ö —Ä–∞—Å—Å—É–∂–¥–µ–Ω–∏–π –≤—ã–¥–µ–ª–∏ –∏–∑ —Ç–µ–∫—Å—Ç–∞ –Ω–∏–∂–µ:

    1. –ù–∞–∑–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ –∫—É–ª—å—Ç—É—Ä–Ω–æ–≥–æ –Ω–∞—Å–ª–µ–¥–∏—è
    2. –ê–¥—Ä–µ—Å –æ–±—ä–µ–∫—Ç–∞ –∫—É–ª—å—Ç—É—Ä–Ω–æ–≥–æ –Ω–∞—Å–ª–µ–¥–∏—è
    3. –ó–∞–∫–∞–∑—á–∏–∫ –∏–ª–∏ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫ –æ–±—ä–µ–∫—Ç–∞ –∫—É–ª—å—Ç—É—Ä–Ω–æ–≥–æ –Ω–∞—Å–ª–µ–¥–∏—è
    4. –í–∏–¥—ã —Ä–∞–±–æ—Ç: —Ä–µ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è, —Ä–µ—Å—Ç–∞–≤—Ä–∞—Ü–∏—è –∏ –¥—Ä (–º–æ–∂–Ω–æ —Å –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç—è–º–∏, –µ—Å–ª–∏ –µ—Å—Ç—å)
    5. –ë—ã–ª–∏ –ª–∏ –≤—ã—è–≤–ª–µ–Ω—ã –∫–∞–∫–∏–µ-—Ç–æ –æ—Å–æ–±—ã–µ –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞
    6. –ö—Ä–∞—Ç–∫–æ–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ –∏–ª–∏ –≤—ã–≤–æ–¥

    –í–æ—Ç —Ç–µ–∫—Å—Ç: {{ text }}

alert:
  templates:
    expertise: |
      {% for event in events %}
      === –≠–∫—Å–ø–µ—Ä—Ç–∏–∑–∞ {{ loop.index }} ===
      –ù–∞–∑–≤–∞–Ω–∏–µ: {{ event.title }}
      {% if event.gpt_text %}
      üìù –í—ã–¥–µ—Ä–∂–∫–∞:
      {{ event.gpt_text }}
      {% else %}
      ‚ÑπÔ∏è –í—ã–¥–µ—Ä–∂–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
      {% endif %}
      {% endfor %}
      
test_event:
  url: https://kgiop.gov.spb.ru/media/uploads/userfiles/2023/example_gike.pdf
  note: –¢–µ—Å—Ç–æ–≤–∞—è —ç–∫—Å–ø–µ—Ä—Ç–∏–∑–∞ 2023 –≥–æ–¥–∞
