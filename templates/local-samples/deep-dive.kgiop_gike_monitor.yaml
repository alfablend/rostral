version: 1

meta:
  id: deep-dive.kgiop_gike_monitor
  name: –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ì–ò–ö–≠ –ö–ì–ò–û–ü
  description: –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –ø–æ—è–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –∏—Å—Ç–æ—Ä–∏–∫–æ-–∫—É–ª—å—Ç—É—Ä–Ω—ã—Ö —ç–∫—Å–ø–µ—Ä—Ç–∏–∑ –Ω–∞ —Å–∞–π—Ç–µ –ö–ì–ò–û–ü –°–ü–±
  tags: ["–∫—É–ª—å—Ç—É—Ä–Ω–æ–µ –Ω–∞—Å–ª–µ–¥–∏–µ", "–°–ü–±", "—ç–∫—Å–ø–µ—Ä—Ç–∏–∑—ã", "PDF"]
  category: "deep-dive"

source:
  type: html
  url: |
    {% set current_year = now().year %}
    https://kgiop.gov.spb.ru/deyatelnost/zaklyucheniya-gosudarstvennyh-istoriko-kulturnyh-ekspertiz/gosudarstvennye-istoriko-kulturnye-ekspertizy-za-{{ current_year }}-g/
  frequency: daily
  fetch:
    retry_policy:
      max_retries: 3
      backoff_factor: 2

extract:
  expertises:
    selector: "a[href*='/media/uploads/userfiles/'], a[href*='disk.yandex.ru']"
    type: list
    fields:
      title: "self"
      url:
        attr: "href"
        transform: |
          {% if 'disk.yandex.ru' in value %}
            {% set api_url = 'https://cloud-api.yandex.net/v1/disk/public/resources/download?public_key=' + value %}
            {% set response = http.get(api_url) %}
            {{ response.json().href }}
          {% else %}
            {{ 'https://kgiop.gov.spb.ru' + value }}
          {% endif %}

normalize:
  rules:
    - field: expertises
      filters:
        - unique: "url"
        - filter: "documents"
          condition: "url.endswith('.pdf')"

gpt:
  prompt: |
    –ê–Ω–∞–ª–∏–∑ –∏—Å—Ç–æ—Ä–∏–∫–æ-–∫—É–ª—å—Ç—É—Ä–Ω–æ–π —ç–∫—Å–ø–µ—Ä—Ç–∏–∑—ã:
    1. –û–±—ä–µ–∫—Ç: {{ extract("–æ–±—ä–µ–∫—Ç –∫—É–ª—å—Ç—É—Ä–Ω–æ–≥–æ –Ω–∞—Å–ª–µ–¥–∏—è", "–∞–¥—Ä–µ—Å") }}
    2. –ó–∞–∫–∞–∑—á–∏–∫: {{ extract("–∑–∞–∫–∞–∑—á–∏–∫", "—Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫") }}
    3. –†–∞–±–æ—Ç—ã: {{ extract("–≤–∏–¥—ã —Ä–∞–±–æ—Ç", "—Ä–µ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è", "—Ä–µ—Å—Ç–∞–≤—Ä–∞—Ü–∏—è") }}
    4. –í—ã–≤–æ–¥—ã: {{ extract("–∑–∞–∫–ª—é—á–µ–Ω–∏–µ", "—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏") }}
    5. –ö–∞–¥–∞—Å—Ç—Ä–æ–≤—ã–µ –Ω–æ–º–µ—Ä–∞: {{ extract("–∫–∞–¥–∞—Å—Ç—Ä–æ–≤—ã–π –Ω–æ–º–µ—Ä") }}

alert:
  template: |
    üèõ –ù–æ–≤—ã–π –ì–ò–ö–≠ {{ now().year }} –≥–æ–¥–∞
    –û–±—ä–µ–∫—Ç: {{ gpt.object|default("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö") }}
    –ê–¥—Ä–µ—Å: {{ gpt.address|default("–ù–µ —É–∫–∞–∑–∞–Ω") }}
    {% if gpt.kadastr %}–ö–∞–¥–∞—Å—Ç—Ä: {{ gpt.kadastr }}{% endif %}
    üîó –°—Å—ã–ª–∫–∞: {{ normalized.url }}

test_event:
  url: https://kgiop.gov.spb.ru/media/uploads/userfiles/2023/example_gike.pdf
  note: –¢–µ—Å—Ç–æ–≤–∞—è —ç–∫—Å–ø–µ—Ä—Ç–∏–∑–∞ 2023 –≥–æ–¥–∞
